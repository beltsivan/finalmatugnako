@model IEnumerable<WebApplication1.Models.LockerRequest>
@{
    ViewData["Title"] = "Admin - Locker Requests";
}

<div class="container py-4">
    

            <div class="p-3 d-flex justify-content-between">
                <div>
                    <button id="prevPanelBtn" class="btn btn-primary">Previous</button>
                </div>
                <h2>View More Forms</h2>
                <div>
                    <button id="nextPanelBtn" class="btn btn-primary">Next</button>
                </div>
            </div>

            <!-- container where other admin tables (LockerRequests / Reservation / Student) will be loaded -->
            <div id="adminPanelsContainer" class="mt-3">
                <div class="card shadow-sm">
                    <div class="card-body p-0">
                        <div class="d-flex justify-content-between align-items-center mb-4 px-3">
                            <h2 class="mb-0" style="color: black">Admin - Locker Requests</h2>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>ID</th>
                                        <th>Locker</th>
                                        <th>Semester</th>
                                        <th>Contact</th>
                                        <th>File</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{int counter = 1;}
                                    @foreach (var r in Model)
                                    {
                                        <tr>
                                            <td>@(counter++)</td>
                                            <td>@r.Name</td>
                                            <td>@r.IdNumber</td>
                                            <td>@r.LockerNumber</td>
                                            <td>@r.Semester</td>
                                            <td>@r.ContactNumber</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(r.RegistrationFilePath))
                                                {
                                                    <a href="@r.RegistrationFilePath" target="_blank">View</a>
                                                }
                                            </td>
                                            <td>
                                                @{
                                                    var status = r.Approved == null ? "Pending" : r.Approved == true ? "Approved" : "Rejected";
                                                    var approver = !string.IsNullOrEmpty(r.Approver) && r.Approver != "Pending" ? $"by {r.Approver}" : "";
                                                }
                                                <span class="@(status == "Approved" ? "text-success" : status == "Rejected" ? "text-danger" : "text-warning")">
                                                    @status
                                                </span>
                                                @if (!string.IsNullOrEmpty(approver))
                                                {
                                                    <br />
                                                    <small class="text-muted">@approver</small>
                                                }
                                            </td>
                                            <td style="white-space:nowrap;">
                                                <form asp-action="Approve" method="post" style="display:inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@r.Id" />
                                                    <input type="hidden" name="approve" value="true" />
                                                    <button type="submit" class="btn btn-success btn-sm">Approve</button>
                                                </form>

                                                <form asp-action="Approve" method="post" style="display:inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@r.Id" />
                                                    <input type="hidden" name="approve" value="false" />
                                                    <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                                                </form>

                                                <form asp-action="Delete" method="post" style="display:inline" onsubmit="return confirm('Are you sure you want to delete this request?');">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@r.Id" />
                                                    <button type="submit" class="btn btn-secondary btn-sm">Delete</button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            <nav aria-label="Page navigation" class="d-flex justify-content-center mt-3">
                                <ul class="pagination">
                                    @if (ViewBag.CurrentPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link admin-page-link" href="@Url.Action("Admin", "LockerRequests", new { page = ViewBag.CurrentPage - 1 })">&laquo;</a>
                                        </li>
                                    }
                                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                    {
                                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                            <a class="page-link admin-page-link" href="@Url.Action("Admin", "LockerRequests", new { page = i })">@i</a>
                                        </li>
                                    }
                                    @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link admin-page-link" href="@Url.Action("Admin", "LockerRequests", new { page = ViewBag.CurrentPage + 1 })">&raquo;</a>
                                        </li>
                                    }
                                </ul>
                            </nav>

                        </div> <!-- /.table-responsive -->
                    </div> <!-- /.card-body -->
                </div> <!-- /.card -->
            </div>

        </div> <!-- /.container -->

        <style>
            /* simple fade animation for panel transitions */
            .fade-out { opacity: 0; transition: opacity 300ms ease; }
            .fade-in { opacity: 1; transition: opacity 300ms ease; }
        </style>

        @section Scripts {
            <script>
                (function(){
                    const prevBtn = document.getElementById('prevPanelBtn');
                    const nextBtn = document.getElementById('nextPanelBtn');
                    const container = document.getElementById('adminPanelsContainer');

                    // capture the current locker requests card HTML so we can restore it
                    const cardBody = container.querySelector('.card');
                    const originalHtml = cardBody ? cardBody.outerHTML : '';

                    const panels = [
                        { type: 'html', content: originalHtml },
                        { type: 'url', url: '/Reservation/AdminList' },
                        { type: 'url', url: '/Student/AdminList' }
                    ];

                    // intercept pagination links inside injected panels and load via AJAX
                    container.addEventListener('click', function(e){
                        const a = e.target.closest && e.target.closest('a.admin-page-link');
                        if (!a) return;
                        e.preventDefault();
                        const url = a.getAttribute('href');
                        fetch(url, { credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                            .then(r => { if (!r.ok) throw new Error(r.status); return r.text(); })
                            .then(html => setPanelHtml(html))
                            .catch(err => setPanelHtml('<div class="alert alert-danger">Error loading page: ' + err.message + '</div>'));
                    });

                    let idx = 0; // currently showing locker requests (index 0)

                    function setPanelHtml(html){
                        // fade out
                        container.classList.add('fade-out');
                        setTimeout(() => {
                            try {
                                // Parse the returned HTML and try to extract only the inner admin panel
                                var parser = new DOMParser();
                                var doc = parser.parseFromString(html, 'text/html');
                                var extracted = doc.getElementById('adminPanelsContainer');
                                if (extracted) {
                                    // Insert only the inner content to avoid duplicating outer controls
                                    container.innerHTML = extracted.innerHTML;
                                } else {
                                    // Fallback: server returned a fragment already
                                    container.innerHTML = html;
                                }
                            } catch (e) {
                                // If parsing fails, fallback to raw HTML
                                container.innerHTML = html;
                            }

                            container.classList.remove('fade-out');
                            container.classList.add('fade-in');
                            // remove fade-in class after animation so it can be reused
                            setTimeout(() => container.classList.remove('fade-in'), 350);
                        }, 300);
                    }

                    async function loadPanel(panel){
                        if (panel.type === 'html'){
                            setPanelHtml(panel.content);
                            return;
                        }
                        try{
                            const res = await fetch(panel.url, { credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                            if (!res.ok) throw new Error('Failed to load: ' + res.status);
                            const text = await res.text();
                            setPanelHtml(text);
                        } catch (err){
                            setPanelHtml('<div class="alert alert-danger">Error loading panel: ' + err.message + '</div>');
                        }
                    }

                    nextBtn.addEventListener('click', function(){
                        idx = (idx + 1) % panels.length;
                        loadPanel(panels[idx]);
                    });

                    prevBtn.addEventListener('click', function(){
                        idx = (idx - 1 + panels.length) % panels.length;
                        loadPanel(panels[idx]);
                    });

                })();
            </script>
        }
